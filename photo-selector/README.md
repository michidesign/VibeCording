# Photo Selector - 写真自動選定ツール

子供の写真アルバム作成のため、大量の写真を自動評価し、7段階に分類するツールです。

## このツールでできること

- 大量の写真（数百〜数千枚）を自動で品質評価
- 「最高」から「非常に悪い」まで7段階に自動分類
- 顔検出による笑顔・目の開閉チェック
- ブレ・ピンボケの自動検出
- 撮影日時順にファイルを整理

## 特徴

- **完全ローカル処理**: 写真をインターネットにアップロードしません（プライバシー安全）
- **完全無料**: すべてオープンソースのライブラリを使用
- **時系列管理**: 撮影日時をファイル名に付加して時系列順に管理
- **中断・再開対応**: 処理を途中でやめても、次回続きから処理可能

---

## はじめに（セットアップ）

### 必要なもの

- Mac（macOS）
- Python 3.8以上（Macには標準でインストール済み）

### 手順

#### ステップ1: ターミナルを開く

1. Macで「アプリケーション」→「ユーティリティ」→「ターミナル」を開きます
2. または、Spotlight検索（Command + スペース）で「ターミナル」と入力して開きます

#### ステップ2: ツールのフォルダに移動

ターミナルに以下を入力してEnterキーを押します：

```bash
cd ~/Desktop/photo-selector
```

#### ステップ3: 仮想環境を作成（初回のみ）

以下のコマンドを1行ずつ入力してEnterキーを押します：

```bash
python3 -m venv venv
```

#### ステップ4: 仮想環境を有効化

```bash
source venv/bin/activate
```

成功すると、ターミナルの行頭に `(venv)` と表示されます。

#### ステップ5: 必要なライブラリをインストール（初回のみ）

```bash
pip install -r requirements.txt
```

これで準備完了です。

---

## 使い方

### 基本的な使い方

写真を分類するには、以下のコマンドを実行します：

```bash
python photo_selector.py --input 写真があるフォルダ --output 結果を保存するフォルダ
```

### 具体例

#### 例1: デスクトップの写真フォルダを処理

```bash
python photo_selector.py --input ~/Desktop/写真2024 --output ~/Desktop/写真2024_分類済み
```

#### 例2: ピクチャフォルダの写真を処理

```bash
python photo_selector.py --input ~/Pictures/子供の写真 --output ~/Desktop/アルバム候補
```

### 2回目以降の実行

毎回、仮想環境を有効化してから実行してください：

```bash
cd ~/Desktop/photo-selector
source venv/bin/activate
python photo_selector.py --input 写真があるフォルダ --output 結果を保存するフォルダ
```

---

## 処理結果

実行が完了すると、指定した出力フォルダに以下の構造で保存されます：

```
出力フォルダ/
├── 1_最高/           # 75点以上（アルバム最優先）
├── 2_とても良い/     # 65〜74点（アルバム候補）
├── 3_良い/           # 55〜64点（アルバム検討）
├── 4_普通/           # 45〜54点（予備候補）
├── 5_やや悪い/       # 35〜44点（検討対象外）
├── 6_悪い/           # 25〜34点（除外推奨）
├── 7_非常に悪い/     # 25点未満（除外推奨）
└── results.csv       # 全写真のスコア詳細（Excel等で開けます）
```

### アルバム作成の目安

| フォルダ | スコア | アルバムへの使用 |
|----------|--------|------------------|
| 1_最高 | 75点以上 | 優先的に使用 |
| 2_とても良い | 65〜74点 | 積極的に使用 |
| 3_良い | 55〜64点 | 必要に応じて使用 |
| 4_普通 | 45〜54点 | 他に良い写真がなければ使用 |
| 5_やや悪い | 35〜44点 | 基本的に使用しない |
| 6_悪い | 25〜34点 | 使用しない |
| 7_非常に悪い | 25点未満 | 使用しない |

### ファイル名について

出力されるファイルには、撮影日時が先頭に追加されます：

- 元のファイル名: `IMG_1234.jpg`
- 出力ファイル名: `20240101_120530_IMG_1234.jpg`

これにより、ファイル名順で並べると自動的に時系列順になります。

### results.csv について

Excelやスプレッドシートで開くと、各写真の詳細スコアを確認できます：

| 列名 | 説明 |
|------|------|
| ファイル名 | 元のファイル名 |
| 撮影日時 | 写真を撮った日時 |
| 分類 | 7段階の分類結果 |
| 総合スコア | 100点満点の総合評価 |
| 顔検出 | 顔があるか（あり/なし） |
| シャープさ | ブレ・ピンボケの評価 |
| 露出 | 明るさの評価 |
| コントラスト | メリハリの評価 |
| 顔サイズ | 顔が適切な大きさかの評価 |
| 目の開閉 | 目を開けているかの評価 |
| 笑顔 | 笑っているかの評価 |
| 構図 | 顔の位置の評価 |
| 元ファイルパス | 入力フォルダ内のファイルパス |
| 出力先パス | 分類後のファイルパス |

---

## 評価基準の詳細

### 顔が写っている写真（100点満点）

| 評価項目 | 配点 | 説明 |
|----------|------|------|
| 構図 | 30点 | 顔が写真の良い位置にあるか |
| 笑顔 | 25点 | 笑っているか |
| シャープさ | 20点 | ブレ・ピンボケがないか |
| 目の開閉 | 15点 | 目を閉じていないか |
| 露出 | 5点 | 明るさが適切か |
| 顔サイズ | 5点 | 顔が適切な大きさか |

### 顔がない写真（風景・物など）（100点満点）

| 評価項目 | 配点 | 説明 |
|----------|------|------|
| シャープさ | 40点 | ブレ・ピンボケがないか |
| 露出 | 35点 | 明るさが適切か |
| コントラスト | 25点 | メリハリがあるか |

---

## オプション機能

### バッチサイズの指定

写真が多い場合（1000枚以上など）、一度に処理する枚数を指定できます：

```bash
python photo_selector.py --input ~/Desktop/写真 --output ~/Desktop/結果 --batch-size 300
```

これにより、300枚ずつ処理されます。途中で中断しても、次回は続きから処理されます。

---

## 途中で中断した場合

処理を途中でやめた場合（ターミナルを閉じた、Ctrl+Cで停止した、など）、
次回同じコマンドを実行すると、処理済みのファイルは自動的にスキップされ、続きから処理されます。

### 最初からやり直したい場合

出力フォルダ内の `.processed.txt` ファイルを削除してください：

```bash
rm ~/Desktop/結果フォルダ/.processed.txt
```

または、Finderで出力フォルダを開き、隠しファイルを表示（Command + Shift + .）して `.processed.txt` を削除してください。

---

## よくある質問

### Q: 処理にどのくらい時間がかかりますか？

A: 写真1枚あたり約0.5〜1秒程度です。1000枚で約10〜15分が目安です。

### Q: 元の写真は消えますか？

A: いいえ、元の写真は削除されません。このツールは写真を「コピー」するだけです。

### Q: 対応している画像形式は？

A: JPG（JPEG）とPNGに対応しています。

### Q: 横顔は検出されますか？

A: このツールは正面顔の検出に最適化されています。横顔や斜めの顔は検出されにくい場合があります。

### Q: スコアが低い写真も残しておくべき？

A: 元のフォルダに写真は残っているので、出力フォルダから削除しても問題ありません。ただし、機械的な評価なので、思い出深い写真は手動で確認することをお勧めします。

---

## トラブルシューティング

### 「command not found: python3」と表示される

Pythonがインストールされていない可能性があります。以下のコマンドでインストールしてください：

```bash
xcode-select --install
```

### 「No such file or directory」と表示される

指定したフォルダのパスが間違っている可能性があります。パスを確認してください。
フォルダをターミナルにドラッグ＆ドロップすると、正確なパスを入力できます。

### 処理が遅い

- バッチサイズを小さくしてみてください（`--batch-size 200` など）
- 他のアプリを閉じてメモリを確保してください

### 仮想環境が有効化できない

ターミナルの行頭に `(venv)` が表示されていることを確認してください。
表示されていない場合は、再度以下を実行してください：

```bash
cd ~/Desktop/photo-selector
source venv/bin/activate
```

---

## 技術仕様

- 使用言語: Python 3.8+
- 顔検出: OpenCV Haar Cascade
- 画像処理: OpenCV, Pillow
- EXIF読み取り: Pillow

### 依存ライブラリ

- opencv-python>=4.8.0
- opencv-contrib-python>=4.8.0
- Pillow>=10.0.0
- numpy>=1.24.0
- tqdm>=4.65.0
